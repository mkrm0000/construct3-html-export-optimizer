<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Construct 3 Optimizer</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom scrollbar for dark mode */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background-color: #6366f1; /* indigo-500 */
      border-radius: 4px;
    }
    ::-webkit-scrollbar-track {
      background-color: #1e293b; /* slate-800 */
    }
  </style>
</head>
<body class="bg-slate-900 text-indigo-300 min-h-screen flex items-center justify-center p-6">
  <div class="max-w-lg w-full bg-slate-800 rounded-lg shadow-lg p-8 space-y-6">
    <h1 class="text-3xl font-semibold text-indigo-400 text-center">Construct 3 Optimizer</h1>

    <!-- Compression Level -->
    <div>
      <label for="compression" class="block mb-2 font-medium text-indigo-200">Compression Level:</label>
      <select id="compression" class="w-full rounded-md bg-slate-700 border border-indigo-600 text-indigo-300 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <option value="high">High (best quality)</option>
        <option value="medium" selected>Medium</option>
        <option value="low">Low (more compression)</option>
      </select>
    </div>

    <!-- File selector and filename display -->
    <div>
      <label for="fileInput" class="block mb-2 font-medium text-indigo-200 cursor-pointer" id="dropZone" >
        <div class="border-2 border-dashed border-indigo-600 rounded-md p-6 text-center text-indigo-400 hover:border-indigo-400 hover:text-indigo-300 transition cursor-pointer select-none">
          <p>Click to select a ZIP file or drag & drop here</p>
          <input type="file" id="fileInput" accept=".zip" class="hidden" />
        </div>
      </label>
      <!-- Filename text, hidden initially -->
      <p id="selectedFileName" class="mt-3 text-center text-indigo-300 font-medium break-all hidden"></p>
    </div>

    <!-- Upload button -->
    <button id="uploadBtn" disabled class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-md transition disabled:opacity-50 disabled:cursor-not-allowed">
      Upload
    </button>

    <!-- Progress section -->
    <div id="progressContainer" class="hidden space-y-2">
      <p class="text-center font-medium">Progress: <span id="progressText">0%</span></p>
      <progress id="progressBar" value="0" max="100" class="w-full rounded-md h-4"></progress>
      <p class="text-center text-indigo-400">Currently processing: <span id="currentFile">None</span></p>
    </div>

    <!-- Download link -->
    <div id="downloadContainer" class="hidden mt-4 text-center">
      <a id="downloadLink" href="" download class="inline-block bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-6 rounded-md transition">Download Optimized ZIP</a>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const selectedFileName = document.getElementById('selectedFileName');
    const uploadBtn = document.getElementById('uploadBtn');

    // Enable upload button only when a file is selected
    fileInput.addEventListener('change', (e) => {
      if (fileInput.files.length > 0) {
        onFileSelected(fileInput.files[0]);
      }
    });

    // Drag and drop handlers
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('border-indigo-400', 'text-indigo-300');
    });

    dropZone.addEventListener('dragleave', (e) => {
      dropZone.classList.remove('border-indigo-400', 'text-indigo-300');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-indigo-400', 'text-indigo-300');
      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].name.toLowerCase().endsWith('.zip')) {
        fileInput.files = files; // Set files to input
        onFileSelected(files[0]);
      } else {
        alert('Please drop a valid ZIP file.');
      }
    });

    function onFileSelected(file) {
      // Hide drag & drop label
      dropZone.style.display = 'none';

      // Show filename text
      selectedFileName.textContent = file.name;
      selectedFileName.classList.remove('hidden');

      // Enable upload button
      uploadBtn.disabled = false;
    }

    uploadBtn.addEventListener('click', () => {
      if (!fileInput.files.length) return alert('Please select a ZIP file.');

      const compression = document.getElementById('compression').value;
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('compression', compression);

      // Hide upload button and compression select during processing
      uploadBtn.style.display = 'none';
      document.getElementById('compression').disabled = true;

      // Show progress container
      document.getElementById('progressContainer').classList.remove('hidden');
      document.getElementById('downloadContainer').classList.add('hidden');

      fetch('/upload', { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
          const taskId = data.task_id;
          pollProgress(taskId);
        })
        .catch(() => {
          alert('Upload failed.');
          resetUI();
        });
    });

    function pollProgress(taskId) {
      const interval = setInterval(() => {
        fetch(`/progress/${taskId}`)
          .then(res => res.json())
          .then(data => {
            const progress = data.progress;
            const currentFile = data.current_file || 'None';

            document.getElementById('progressText').innerText = `${progress}%`;
            document.getElementById('progressBar').value = progress;
            document.getElementById('currentFile').innerText = currentFile;

            if (progress >= 100) {
              clearInterval(interval);
              document.getElementById('downloadLink').href = `/download/${taskId}`;
              document.getElementById('downloadContainer').classList.remove('hidden');
            }
          })
          .catch(() => {
            clearInterval(interval);
            alert('Error fetching progress.');
            resetUI();
          });
      }, 1000);
    }

    function resetUI() {
      dropZone.style.display = 'block';
      selectedFileName.classList.add('hidden');
      selectedFileName.textContent = '';
      uploadBtn.style.display = 'block';
      uploadBtn.disabled = true;
      document.getElementById('compression').disabled = false;
      document.getElementById('progressContainer').classList.add('hidden');
      document.getElementById('downloadContainer').classList.add('hidden');
      document.getElementById('progressText').innerText = '0%';
      document.getElementById('progressBar').value = 0;
      document.getElementById('currentFile').innerText = 'None';
      fileInput.value = '';
    }
  </script>
</body>
</html>
